import { connectorsApi } from "../api/connectorsApi.js";
import { domainsApi } from "../api/domainsApi.js";
import { payApi } from "../api/payApi.js";
import viewPaymentsList from "../views/PaymentsList.js";
import viewPaymentTest from "../views/PaymentTest.js";
import { HTTPError } from "got";
import { Composer } from "grammy";
import { nanoid } from "nanoid";
export const payments = new Composer();
payments.callbackQuery(/^payments:(\d+)$/, async (ctx)=>{
    await ctx.answerCallbackQuery();
    const { projectId } = ctx.session;
    if (!projectId) return;
    const page = parseInt(ctx.match[1], 10) || 1;
    const { message, kb } = await viewPaymentsList(projectId, page);
    await ctx.editMessageText(message, {
        reply_markup: kb,
        parse_mode: 'HTML'
    });
});
payments.callbackQuery('payments:test', async (ctx)=>{
    await ctx.answerCallbackQuery();
    const { projectId } = ctx.session;
    if (!projectId) return;
    const domains = await domainsApi.getDomains({
        projectId
    });
    const connectors = await connectorsApi.getConnectors({
        projectId,
        active: true
    });
    if (!connectors.length) return ctx.reply('üòî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤');
    const statuses = connectors.map((c)=>({
            connector: c,
            status: '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞',
            paymentUuid: null
        }));
    if (!domains.length) return ctx.reply('üòî –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤');
    const update = async (id, status, uuid)=>{
        const s = statuses.find((v)=>v.connector.id === id);
        if (!s) return;
        Object.assign(s, {
            status,
            paymentUuid: uuid
        });
        const { message, kb } = viewPaymentTest(statuses);
        await ctx.editMessageText(message, {
            reply_markup: kb,
            parse_mode: 'HTML'
        });
    };
    for (const c of connectors){
        await update(c.id, 'üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞', null);
        try {
            const p = await payApi.pay({
                domain: domains[0]?.value || '',
                orderId: nanoid(),
                amount: 100,
                description: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç—ë–∂',
                projectId,
                connectorId: c.id
            });
            await update(c.id, '‚úÖ –ü–ª–∞—Ç—ë–∂ —Å–æ–∑–¥–∞–Ω', p.id);
        } catch (e) {
            const msg = e instanceof HTTPError && e.response.body?.error ? e.response.body.error : '–û—à–∏–±–∫–∞';
            await update(c.id, '‚ùå ' + msg, null);
        }
    }
});
